==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stderr <==

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stdout <==

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==

DEBUGNOTE[22:40:53,697]: check_host(): ps can watch root processes: yes
x11docker[22:40:53,712]: Image name: sickcodes/docker-osx:latest
  Container command: 

DEBUGNOTE[22:40:53,748]: host user: werner 1000:1000 /home/werner
x11docker WARNING: User werner is member of group docker.
  That allows unprivileged processes on host to gain root privileges.

DEBUGNOTE[22:40:54,114]: storeinfo(): cache=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706
DEBUGNOTE[22:40:54,127]: storeinfo(): stdout=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stdout
DEBUGNOTE[22:40:54,139]: storeinfo(): stderr=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stderr
DEBUGNOTE[22:40:54,178]: storeinfo(): x11dockerpid=781593
DEBUGNOTE[22:40:54,257]: 
x11docker version: 6.7.0-beta
docker version:    Docker version 20.10.2, build 2291f61
Host system:       "Ubuntu 20.04.1 LTS"
Host architecture: amd64 (x86_64)
Command:           '/home/werner/Public/repo/github.com/mviereck/x11docker.git/x11docker' '--hostdisplay' '--clipboard' '--workdir' '/home/arch/OSX-KVM' '--interactive' '--user=RETAIN' '--cap-default' '--' '-p' '50922:10022' '--' 'sickcodes/docker-osx:latest' 
Parsed options:     --hostdisplay --clipboard --workdir '/home/arch/OSX-KVM' --interactive --user 'RETAIN' --cap-default -- '-p' '50922:10022' '--' 'sickcodes/docker-osx:latest'
DEBUGNOTE[22:40:54,314]: Dependency check for --hostdisplay: 0
DEBUGNOTE[22:40:54,319]: Dependencies of --hostdisplay already checked: 0 
DEBUGNOTE[22:40:54,324]: Dependencies of --hostdisplay already checked: 0 
DEBUGNOTE[22:40:54,329]: storeinfo(): xserver=--hostdisplay
x11docker WARNING: Option --clipboard: To allow clipboard sharing with
  option --hostdisplay, trusted cookies will be enabled.
  No protection against X security leaks is left!
  Consider to use another X server option.

x11docker WARNING: Option --cap-default disables security hardening
  for containers done by x11docker. Default docker capabilities are allowed.
  This is considered to be less secure.

x11docker note: Option --cap-default: Enabling option --newprivileges.
  You can avoid this with --newprivileges=no

x11docker note: Option --hostdisplay: To allow --hostdisplay with trusted cookies,
  x11docker must share host IPC namespace with container (option --hostipc)
  to allow shared memory for X extension MIT-SHM.

x11docker WARNING: Option --hostdisplay with trusted cookies provides
      QUITE BAD CONTAINER ISOLATION !
  Keylogging and controlling host applications is possible! 
  Clipboard sharing is enabled (option --cliboard).
  It is recommended to use another X server option like --nxagent or --xpra.

x11docker note: Option --hostdisplay may fail with proprietary NVIDIA driver
  on host. In that case try other X server options like 
  --nxagent, --xpra or --xephyr.

x11docker WARNING: Option --hostipc severely degrades 
  container isolation. IPC namespace remapping is disabled.

x11docker WARNING: Found custom DOCKER_RUN_OPTIONS.
  x11docker will add them to 'docker run' command without
  a serious check for validity or security. Found options:
   '-p' '50922:10022'


==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/xinit.log <==

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stderr <==

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stdout <==

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==

DEBUGNOTE[22:40:53,697]: check_host(): ps can watch root processes: yes
x11docker[22:40:53,712]: Image name: sickcodes/docker-osx:latest
  Container command: 

DEBUGNOTE[22:40:53,748]: host user: werner 1000:1000 /home/werner
x11docker WARNING: User werner is member of group docker.
  That allows unprivileged processes on host to gain root privileges.

DEBUGNOTE[22:40:54,114]: storeinfo(): cache=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706
DEBUGNOTE[22:40:54,127]: storeinfo(): stdout=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stdout
DEBUGNOTE[22:40:54,139]: storeinfo(): stderr=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stderr
DEBUGNOTE[22:40:54,178]: storeinfo(): x11dockerpid=781593
DEBUGNOTE[22:40:54,257]: 
x11docker version: 6.7.0-beta
docker version:    Docker version 20.10.2, build 2291f61
Host system:       "Ubuntu 20.04.1 LTS"
Host architecture: amd64 (x86_64)
Command:           '/home/werner/Public/repo/github.com/mviereck/x11docker.git/x11docker' '--hostdisplay' '--clipboard' '--workdir' '/home/arch/OSX-KVM' '--interactive' '--user=RETAIN' '--cap-default' '--' '-p' '50922:10022' '--' 'sickcodes/docker-osx:latest' 
Parsed options:     --hostdisplay --clipboard --workdir '/home/arch/OSX-KVM' --interactive --user 'RETAIN' --cap-default -- '-p' '50922:10022' '--' 'sickcodes/docker-osx:latest'
DEBUGNOTE[22:40:54,314]: Dependency check for --hostdisplay: 0
DEBUGNOTE[22:40:54,319]: Dependencies of --hostdisplay already checked: 0 
DEBUGNOTE[22:40:54,324]: Dependencies of --hostdisplay already checked: 0 
DEBUGNOTE[22:40:54,329]: storeinfo(): xserver=--hostdisplay
x11docker WARNING: Option --clipboard: To allow clipboard sharing with
  option --hostdisplay, trusted cookies will be enabled.
  No protection against X security leaks is left!
  Consider to use another X server option.

x11docker WARNING: Option --cap-default disables security hardening
  for containers done by x11docker. Default docker capabilities are allowed.
  This is considered to be less secure.

x11docker note: Option --cap-default: Enabling option --newprivileges.
  You can avoid this with --newprivileges=no

x11docker note: Option --hostdisplay: To allow --hostdisplay with trusted cookies,
  x11docker must share host IPC namespace with container (option --hostipc)
  to allow shared memory for X extension MIT-SHM.

x11docker WARNING: Option --hostdisplay with trusted cookies provides
      QUITE BAD CONTAINER ISOLATION !
  Keylogging and controlling host applications is possible! 
  Clipboard sharing is enabled (option --cliboard).
  It is recommended to use another X server option like --nxagent or --xpra.

x11docker note: Option --hostdisplay may fail with proprietary NVIDIA driver
  on host. In that case try other X server options like 
  --nxagent, --xpra or --xephyr.

x11docker WARNING: Option --hostipc severely degrades 
  container isolation. IPC namespace remapping is disabled.

x11docker WARNING: Found custom DOCKER_RUN_OPTIONS.
  x11docker will add them to 'docker run' command without
  a serious check for validity or security. Found options:
   '-p' '50922:10022'


==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/xinit.log <==

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:54,477]: storepid(): Stored pid '782972' of 'watchpidlist':  782972 pts/1    00:00:00 bash
DEBUGNOTE[22:40:54,521]: storepid(): Stored pid '783015' of 'watchmessagefifo':  783015 pts/1    00:00:00 bash
x11docker[22:40:54,592]: Virtual screen size: 1920x1080

x11docker[22:40:54,637]: Physical screen size:
  Screen 0: minimum 8 x 8, current 1920 x 1080, maximum 32767 x 32767

DEBUGNOTE[22:40:54,682]: storeinfo(): DISPLAY=:1
DEBUGNOTE[22:40:54,695]: storeinfo(): XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
DEBUGNOTE[22:40:54,709]: storeinfo(): XSOCKET=/tmp/.X11-unix/X1
DEBUGNOTE[22:40:54,722]: storeinfo(): XDG_RUNTIME_DIR=/run/user/1000
DEBUGNOTE[22:40:54,736]: storeinfo(): Xenv= DISPLAY=:1 XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client XSOCKET=/tmp/.X11-unix/X1 XDG_RUNTIME_DIR=/run/user/1000
x11docker[22:40:54,952]: --init: Found tini binary: /usr/bin/docker-init

DEBUGNOTE[22:40:54,957]: storeinfo(): tini=/usr/bin/docker-init
DEBUGNOTE[22:40:54,975]: Users and terminal:
  x11docker was started by:                       werner
  As host user serves (running X, storing cache): werner
  Container user will be:                         (retaining USER of image)
  Container user password:                        (unknown)
  Getting permission to run docker with:          eval 
  Terminal for password frontend:                 bash -c
  Running in a terminal:                          yes
  Running on console:                             no
  Running over SSH:                               no
  Running sourced:                                no
  bash $-:                                        hB
x11docker WARNING: Option --newprivileges=yes: x11docker does not set 
  docker run option --security-opt=no-new-privileges. 
  That degrades container security.
  However, this is still within a default docker setup.

DEBUGNOTE[22:40:54,982]: storeinfo(): containername=x11docker_X1_sickcodes-docker-osx-latest_19253248706
DEBUGNOTE[22:40:55,483]: Docker command:
  docker run --tty --interactive \
  --name x11docker_X1_sickcodes-docker-osx-latest_19253248706 \
  --ipc host \
  --security-opt label=type:container_runtime_t \
  --volume '/usr/bin/docker-init':'/usr/local/bin/init':ro \
  --tmpfs /run --tmpfs /run/lock \
  --volume '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share':'/x11docker':rw \
  --volume '/tmp/.X11-unix/X1':'/X1':rw \
  --workdir '/home/arch/OSX-KVM' \
  --entrypoint env \
  --env 'container=docker' \
  --env 'XAUTHORITY=/x11docker/Xauthority.client' \
  --env 'DISPLAY=:1' \
  --env 'HOME=/tmp' \
   '-p' '50922:10022' \
  -- sickcodes/docker-osx:latest /usr/local/bin/init -- /bin/sh - /x11docker/containerrc
x11docker[22:40:55,683]: Generated dockerrc:
     1	#! /usr/bin/env bash
     2	
     3	# dockerrc:
     4	#  This script runs as root (or member of group docker) on host.
     5	#  - inspect image
     6	#  - pull image if needed
     7	#  - create containerrc
     8	#  - set up systemd/elogind cgroup if needed
     9	#  - run window manager in container or from host if needed
    10	
    11	trap '' SIGINT
    12	
    13	askyesno () 
    14	{ 
    15	    local Choice;
    16	    read -t60 -n1 -p "(timeout after 60s assuming no) [Y|n]" Choice;
    17	    [ "$?" = '0' ] && { 
    18	        [[ "$Choice" == [YyJj]* ]] || [ -z "$Choice" ] && return 0
    19	    };
    20	    return 1
    21	}
    22	checkpid () 
    23	{ 
    24	    [ -e "/proc/${1:-NONSENSE}" ]
    25	}
    26	escapestring () 
    27	{ 
    28	    echo "${1:-}" | LC_ALL=C sed -e 's/[^a-zA-Z0-9,._+@=:/-]/\\&/g; '
    29	}
    30	mysleep () 
    31	{ 
    32	    sleep "${1:-1}" 2> /dev/null || sleep 1
    33	}
    34	pspid () 
    35	{ 
    36	    LC_ALL=C ps -p "${1:-}" 2> /dev/null | grep -v 'TIME'
    37	}
    38	rmcr () 
    39	{ 
    40	    case "${1:-}" in 
    41	        "")
    42	            sed "s/$(printf "\r")//g"
    43	        ;;
    44	        *)
    45	            sed -i "s/$(printf "\r")//g" "${1:-}"
    46	        ;;
    47	    esac
    48	}
    49	rocknroll () 
    50	{ 
    51	    [ -s "$Timetosaygoodbyefile" ] && return 1;
    52	    [ -e "$Timetosaygoodbyefile" ] || return 1;
    53	    return 0
    54	}
    55	saygoodbye () 
    56	{ 
    57	    debugnote "time to say goodbye ($*)";
    58	    [ -e "$Timetosaygoodbyefile" ] && echo timetosaygoodbye >> $Timetosaygoodbyefile;
    59	    [ -e "$Timetosaygoodbyefifo" ] && echo timetosaygoodbye >> $Timetosaygoodbyefifo
    60	}
    61	storeinfo () 
    62	{ 
    63	    [ -e "$Storeinfofile" ] || return 1;
    64	    case "${1:-}" in 
    65	        dump)
    66	            grep "^${2:-}=" $Storeinfofile | sed "s/^${2:-}=//"
    67	        ;;
    68	        drop)
    69	            sed -i "/^${2:-}=/d" $Storeinfofile
    70	        ;;
    71	        test)
    72	            grep -q "^${2:-}=" $Storeinfofile
    73	        ;;
    74	        *)
    75	            debugnote "storeinfo(): ${1:-}";
    76	            grep -q "^$(echo "${1:-}" | cut -d= -f1)=" $Storeinfofile && { 
    77	                sed -i "/^$(echo "${1:-}" | cut -d= -f1)=/d" $Storeinfofile
    78	            };
    79	            echo "${1:-}" >> $Storeinfofile
    80	        ;;
    81	    esac
    82	}
    83	storepid () 
    84	{ 
    85	    case "${1:-}" in 
    86	        dump)
    87	            grep -w "${2:-}" "$Storepidfile" | cut -d' ' -f1
    88	        ;;
    89	        test)
    90	            grep -q -w "${2:-}" "$Storepidfile"
    91	        ;;
    92	        *)
    93	            echo "${1:-NOPID}" "${2:-NONAME}" >> "$Storepidfile";
    94	            debugnote "storepid(): Stored pid '${1:-}' of '${2:-}': $(pspid ${1:-} ||:)"
    95	        ;;
    96	    esac
    97	}
    98	waitforlogentry () 
    99	{ 
   100	    local Startzeit Uhrzeit Dauer Count=0 Schlaf;
   101	    local Errorkeys="${4:-}";
   102	    local Warten="${5:-60}";
   103	    local Error=;
   104	    Startzeit="$(date +%s ||:)";
   105	    Startzeit="${Startzeit:-0}";
   106	    [ "$Warten" = "infinity" ] && Warten=32000;
   107	    debugnote "waitforlogentry(): ${1:-}: Waiting for logentry \"${3:-}\" in $(basename ${2:-})";
   108	    while ! grep -q "${3:-}" < "${2:-}"; do
   109	        Count="$(( $Count + 1 ))";
   110	        Uhrzeit="$(date +%s ||:)";
   111	        Uhrzeit="${Uhrzeit:-0}";
   112	        Dauer="$(( $Uhrzeit - $Startzeit ))";
   113	        Schlaf="$(( $Count / 10 ))";
   114	        [ "$Schlaf" = "0" ] && Schlaf="0.5";
   115	        mysleep "$Schlaf";
   116	        [ "$Dauer" -gt "10" ] && debugnote "waitforlogentry(): ${1:-}: Waiting since ${Dauer}s for log entry \"${3:-}\" in $(basename ${2:-})";
   117	        [ "$Dauer" -gt "$Warten" ] && error "waitforlogentry(): ${1:-}: Timeout waiting for entry \"${3:-}\" in $(basename ${2:-})
   118	  Last lines of $(basename ${2:-}):
   119	$(tail "${2:-}")";
   120	        [ "$Errorkeys" ] && grep -i -q -E "$Errorkeys" < "${2:-}" && error "waitforlogentry(): ${1:-}: Found error message in logfile.
   121	  Last lines of logfile $(basename ${2:-}):
   122	$(tail "${2:-}")";
   123	        rocknroll || { 
   124	            debugnote "waitforlogentry(): ${1:-}: Stopped waiting for ${3:-} in $(basename ${2:-}) due to terminating signal.";
   125	            Error=1;
   126	            break
   127	        };
   128	    done;
   129	    [ "$Error" ] && return 1;
   130	    debugnote "waitforlogentry(): ${1:-}: Found log entry \"${3:-}\" in $(basename ${2:-}).";
   131	    return 0
   132	}
   133	
   134	warning() {
   135	  echo "$*:WARNING"   | sed "s/\$/ /" >>$Messagefile
   136	}
   137	note() {
   138	  echo "$*:NOTE"      | sed "s/\$/ /" >>$Messagefile
   139	}
   140	verbose() {
   141	  echo "$*:VERBOSE"   | sed "s/\$/ /" >>$Messagefile
   142	}
   143	debugnote() {
   144	  echo "$*:DEBUGNOTE" | sed "s/\$/ /" >>$Messagefile
   145	}
   146	error() {
   147	  echo "$*:ERROR"     | sed "s/\$/ /" >>$Messagefile
   148	  exit 64
   149	}
   150	stdout() {
   151	  echo "$*:STDOUT"    | sed "s/\$/ /" >>$Messagefile
   152	}
   153	
   154	Containercommand=""
   155	Imagename="sickcodes/docker-osx:latest"
   156	Messagefile='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/message.fifo'
   157	Newxenv=' DISPLAY=:1 XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client XSOCKET=/tmp/.X11-unix/X1 XDG_RUNTIME_DIR=/run/user/1000'
   158	export PATH='/home/werner/.pyenv/plugins/pyenv-virtualenv/shims:/home/werner/.pyenv/shims:/home/werner/.pyenv/plugins/pyenv-virtualenv/shims:/home/werner/.pyenv/shims:/home/werner/.local/bin:/home/werner/Public/repo/github.com/mviereck/x11docker.git:/opt/texlive/2020/bin/x86_64-linux:/home/werner/Public/repo/github.com/BurntSushi/ripgrep.git/target/release:/opt/apache-maven/3.6.3/bin:/opt/openjdk/jdk-14.0.1/bin:/usr/local/nginx/sbin:/home/werner/Public/repo/github.com/smxi/inxi.git:/home/werner/Public/repo/github.com/junegunn/fzf.git/bin:/home/werner/.pyenv/bin:/home/werner/Public/repo/github.com/golang/go.git/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/home/werner/go/bin:'
   159	Storeinfofile='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/store.info'
   160	Storepidfile='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/store.pids'
   161	Timetosaygoodbyefile='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/timetosaygoodbye'
   162	Timetosaygoodbyefifo='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/timetosaygoodbye.fifo'
   163	Xserver='--hostdisplay'
   164	Workdir='/home/arch/OSX-KVM'
   165	
   166	Containerarchitecture=
   167	Containerid=
   168	Containerip=
   169	Dockerlogspid=''
   170	Dockerpull=
   171	Exec=
   172	Entrypoint=
   173	Failure=
   174	Imageuser=
   175	Inspect=
   176	Line=
   177	Pid1pid=
   178	Runtime=
   179	Signal=
   180	Windowmanagermode=
   181	Windowmanagercommand=
   182	Wmcontainerid=
   183	Wmdockercommand=
   184	debugnote 'Running dockerrc: Setup as root or as user docker on host.'
   185	
   186	
   187	# Check whether docker daemon is running, get docker info
   188	docker info >>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/docker.info 2>>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log  || {
   189	  error "Calling docker daemon failed.
   190	  Is docker daemon running at all?
   191	  Try to start docker daemon with:   systemctl start docker
   192	  Last lines of log:
   193	$(rmcr < '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log' | tail)"
   194	}
   195	
   196	# Check default runtime
   197	Runtime="$( { grep 'Default Runtime' < '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/docker.info' ||: ;} | awk '{print $3}' )"
   198	debugnote "dockerrc: Found default Runtime: $Runtime"
   199	debugnote "dockerrc: All $(grep 'Runtimes' < '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/docker.info' ||: )"
   200	[ "$Runtime" != '' ] && {
   201	  case $Runtime in
   202	    kata-runtime)  warning 'Found default docker runtime kata-runtime.
   203	  Please run x11docker with --runtime=kata-runtime to avoid issues.' ;;
   204	    nvidia) [ 'no' = 'yes' ] &&  warning 'Option --gpu: Found default docker runtime nvidia.
   205	  Please run x11docker with --runtime=nvidia to avoid issues.' ;;
   206	    runc|crun|oci) ;;
   207	    *) note "Found unknown container runtime: $Runtime
   208	  Please report at:  https://github.com/mviereck/x11docker" ;;
   209	  esac
   210	}
   211	debugnote "dockerrc: Container Runtime: $Runtime"
   212	storeinfo "runtime=$Runtime"
   213	
   214	# Refresh images.list for x11docker-gui
   215	docker images 2>>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log | grep -v REPOSITORY | awk '{print $1 ":" $2}' >>/home/werner/.cache/x11docker/docker.imagelist.sort
   216	rmcr /home/werner/.cache/x11docker/docker.imagelist.sort
   217	while read -r Line ; do
   218	  grep -q "<none>" <<<$Line || echo $Line >> /home/werner/.cache/x11docker/docker.imagelist
   219	done < <(sort < /home/werner/.cache/x11docker/docker.imagelist.sort)
   220	rm /home/werner/.cache/x11docker/docker.imagelist.sort
   221	
   222	# Check if image sickcodes/docker-osx:latest is available locally
   223	Dockerpull=no
   224	grep -x -q 'sickcodes/docker-osx:latest' < /home/werner/.cache/x11docker/docker.imagelist || grep -x -q 'sickcodes/docker-osx:latest:latest' < /home/werner/.cache/x11docker/docker.imagelist || {
   225	  docker inspect sickcodes/docker-osx:latest >>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log 2>&1 || {
   226	    echo 'Image sickcodes/docker-osx:latest not found locally.' >&2
   227	    echo 'Do you want to pull it from docker hub?' >&2
   228	    askyesno && Dockerpull=yes || error "Image 'sickcodes/docker-osx:latest' not available locally and not pulled from docker hub."
   229	  }
   230	}
   231	
   232	rocknroll || exit 64
   233	
   234	[ "$Dockerpull" = 'yes' ] && {
   235	  note "Pulling image 'sickcodes/docker-osx:latest' from docker hub"
   236	   docker pull sickcodes/docker-osx:latest 1>&2 || error "Pulling docker image 'sickcodes/docker-osx:latest' seems to have failed!"
   237	}
   238	
   239	rocknroll || exit 64
   240	
   241	Inspect="$(docker inspect sickcodes/docker-osx:latest --format='{{.Config.Entrypoint}}{{.Config.Cmd}}[{{.Config.User}}][{{.Config.WorkingDir}}][{{.Architecture}}]')"
   242	
   243	# Check architecture
   244	Containerarchitecture="$(cut -d[ -f6 <<< "$Inspect" | cut -d] -f1)"
   245	debugnote "dockerrc: Image architecture: $Containerarchitecture"
   246	# Check CMD
   247	[ -z "$Containercommand" ] && {
   248	  # extract image command from image if not given on cli
   249	  Containercommand="$(cut -d] -f2 <<< "$Inspect" | cut -d[ -f2)"
   250	  debugnote "dockerrc: Image CMD: $Containercommand"
   251	  echo "$Containercommand" | grep -q /x11docker/containerrc && error 'Recursion error: Found CMD /x11docker/containerrc in image.
   252	  Did you use docker commit with an x11docker container?
   253	  Please build new images with a Dockerfile instead of using docker commit,
   254	  or provide a different container command.'
   255	}
   256	
   257	# Check USER
   258	Imageuser="$(cut -d[ -f4 <<< "$Inspect" | cut -d] -f1)"
   259	debugnote "dockerrc: Image USER: $Imageuser"
   260	storeinfo containeruser="${Imageuser:-root}"
   261	
   262	# Check ENTRYPOINT
   263	Entrypoint="$(cut -d] -f1 <<< "$Inspect" | cut -d[ -f2)"
   264	debugnote "dockerrc: Image ENTRYPOINT: $Entrypoint"
   265	echo "$Entrypoint" | grep -qE 'tini|init|systemd' && {
   266	  note "There seems to be an init system in ENTRYPOINT of image:
   267	    $Entrypoint
   268	  Will disable it as x11docker already runs an init with option --tini.
   269	  To allow this ENTRYPOINT, run x11docker with option --init=none."
   270	  Entrypoint=
   271	}
   272	
   273	[ -z "$Containercommand$Entrypoint" ] && error 'No container command specified and no CMD or ENTRYPOINT found in image.'
   274	
   275	######## Create containerrc ########
   276	
   277	{ echo '#! /bin/sh'
   278	  echo ''
   279	  echo '# containerrc'
   280	  echo '# Created startscript for docker run used as container command.'
   281	  echo '# Runs as unprivileged user in container.'
   282	  echo ''
   283	  echo ''
   284	  echo 'mysleep () 
   285	{ 
   286	    sleep "${1:-1}" 2> /dev/null || sleep 1
   287	}'
   288	  echo 'rocknroll () 
   289	{ 
   290	    [ -s "$Timetosaygoodbyefile" ] && return 1;
   291	    [ -e "$Timetosaygoodbyefile" ] || return 1;
   292	    return 0
   293	}'
   294	  echo 'saygoodbye () 
   295	{ 
   296	    debugnote "time to say goodbye ($*)";
   297	    [ -e "$Timetosaygoodbyefile" ] && echo timetosaygoodbye >> $Timetosaygoodbyefile;
   298	    [ -e "$Timetosaygoodbyefifo" ] && echo timetosaygoodbye >> $Timetosaygoodbyefifo
   299	}'
   300	  echo 'storeinfo () 
   301	{ 
   302	    [ -e "$Storeinfofile" ] || return 1;
   303	    case "${1:-}" in 
   304	        dump)
   305	            grep "^${2:-}=" $Storeinfofile | sed "s/^${2:-}=//"
   306	        ;;
   307	        drop)
   308	            sed -i "/^${2:-}=/d" $Storeinfofile
   309	        ;;
   310	        test)
   311	            grep -q "^${2:-}=" $Storeinfofile
   312	        ;;
   313	        *)
   314	            debugnote "storeinfo(): ${1:-}";
   315	            grep -q "^$(echo "${1:-}" | cut -d= -f1)=" $Storeinfofile && { 
   316	                sed -i "/^$(echo "${1:-}" | cut -d= -f1)=/d" $Storeinfofile
   317	            };
   318	            echo "${1:-}" >> $Storeinfofile
   319	        ;;
   320	    esac
   321	}'
   322	  echo 'waitforlogentry () 
   323	{ 
   324	    local Startzeit Uhrzeit Dauer Count=0 Schlaf;
   325	    local Errorkeys="${4:-}";
   326	    local Warten="${5:-60}";
   327	    local Error=;
   328	    Startzeit="$(date +%s ||:)";
   329	    Startzeit="${Startzeit:-0}";
   330	    [ "$Warten" = "infinity" ] && Warten=32000;
   331	    debugnote "waitforlogentry(): ${1:-}: Waiting for logentry \"${3:-}\" in $(basename ${2:-})";
   332	    while ! grep -q "${3:-}" < "${2:-}"; do
   333	        Count="$(( $Count + 1 ))";
   334	        Uhrzeit="$(date +%s ||:)";
   335	        Uhrzeit="${Uhrzeit:-0}";
   336	        Dauer="$(( $Uhrzeit - $Startzeit ))";
   337	        Schlaf="$(( $Count / 10 ))";
   338	        [ "$Schlaf" = "0" ] && Schlaf="0.5";
   339	        mysleep "$Schlaf";
   340	        [ "$Dauer" -gt "10" ] && debugnote "waitforlogentry(): ${1:-}: Waiting since ${Dauer}s for log entry \"${3:-}\" in $(basename ${2:-})";
   341	        [ "$Dauer" -gt "$Warten" ] && error "waitforlogentry(): ${1:-}: Timeout waiting for entry \"${3:-}\" in $(basename ${2:-})
   342	  Last lines of $(basename ${2:-}):
   343	$(tail "${2:-}")";
   344	        [ "$Errorkeys" ] && grep -i -q -E "$Errorkeys" < "${2:-}" && error "waitforlogentry(): ${1:-}: Found error message in logfile.
   345	  Last lines of logfile $(basename ${2:-}):
   346	$(tail "${2:-}")";
   347	        rocknroll || { 
   348	            debugnote "waitforlogentry(): ${1:-}: Stopped waiting for ${3:-} in $(basename ${2:-}) due to terminating signal.";
   349	            Error=1;
   350	            break
   351	        };
   352	    done;
   353	    [ "$Error" ] && return 1;
   354	    debugnote "waitforlogentry(): ${1:-}: Found log entry \"${3:-}\" in $(basename ${2:-}).";
   355	    return 0
   356	}'
   357	  echo '
   358	warning() {
   359	  echo "$*:WARNING"   | sed "s/\$/ /" >>$Messagefile
   360	}
   361	note() {
   362	  echo "$*:NOTE"      | sed "s/\$/ /" >>$Messagefile
   363	}
   364	verbose() {
   365	  echo "$*:VERBOSE"   | sed "s/\$/ /" >>$Messagefile
   366	}
   367	debugnote() {
   368	  echo "$*:DEBUGNOTE" | sed "s/\$/ /" >>$Messagefile
   369	}
   370	error() {
   371	  echo "$*:ERROR"     | sed "s/\$/ /" >>$Messagefile
   372	  exit 64
   373	}
   374	stdout() {
   375	  echo "$*:STDOUT"    | sed "s/\$/ /" >>$Messagefile
   376	}'
   377	  echo 'Messagefile=/x11docker/message.fifo'
   378	  echo 'Storeinfofile=/x11docker/store.info'
   379	  echo 'Timetosaygoodbyefile=/x11docker/timetosaygoodbye'
   380	  echo ''
   381	  echo 'waitforlogentry containerrc $Storeinfofile containerrootrc=ready  infinity'
   382	  echo 'debugnote "Running containerrc: Unprivileged user commands in container"'
   383	  echo ''
   384	  echo "Containercommand=\"$Containercommand\""
   385	  echo "Entrypoint=\"$Entrypoint\""
   386	  echo ''
   387	  echo 'verbose "containerrc: Container system:'
   388	  echo '$(cat /etc/os-release 2>&1 ||:)"'
   389	  echo ''
   390	} >> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/containerrc
   391	{
   392	  echo ''
   393	  echo '# USER and HOME'
   394	  echo 'Containeruser="$(storeinfo dump containeruser)"'
   395	  echo 'Containeruserhome="$(cat /etc/passwd | grep "$Containeruser:.:" | cut -d: -f6)"'
   396	  echo 'Containeruserhome="${Containeruserhome:-/tmp/$Containeruser}"'
   397	  echo 'mkdir -p "$Containeruserhome"'
   398	  echo 'export USER="$Containeruser"'
   399	  echo 'export HOME="$Containeruserhome"'
   400	  echo ''
   401	  echo '# XDG_RUNTIME_DIR'
   402	  echo 'Containeruseruid=$(id -u $Containeruser)'
   403	  echo 'export XDG_RUNTIME_DIR=/tmp/XDG_RUNTIME_DIR'
   404	  echo '[ -e /run/user/$Containeruseruid ] && ln -s /run/user/$Containeruseruid $XDG_RUNTIME_DIR || mkdir -p -m700 $XDG_RUNTIME_DIR'
   405	  echo ''
   406	  echo '# Copy files from /etc/skel into empty HOME'
   407	  echo '[ -d /etc/skel ] && [ -z "$(ls -A "$Containeruserhome" 2>/dev/null | grep -v -E "gnupg")" ] && {'
   408	  echo '  debugnote "containerrc: HOME is empty. Copying from /etc/skel"'
   409	  echo '  cp -n -R /etc/skel/. $Containeruserhome'
   410	  echo '  :'
   411	  echo '} || {'
   412	  echo '  debugnote "containerrc: HOME is not empty. Not copying from /etc/skel"'
   413	  echo '}'
   414	  echo ''
   415	  echo '# Create softlink to X unix socket'
   416	  echo '[ -e /tmp/.X11-unix/X1 ] || ln -s /X1 /tmp/.X11-unix'
   417	  echo ''
   418	  echo 'unset WAYLAND_DISPLAY'
   419	  echo ''
   420	  echo 'export XDG_SESSION_TYPE=x11'
   421	  echo ''
   422	  echo ''
   423	  echo 'export TERM=xterm'
   424	  echo 'storeinfo test locale && export LANG="$(storeinfo dump locale)"'
   425	  echo '[ -e "/usr/share/zoneinfo/Asia/Shanghai" ] || export TZ=UTC-08'
   426	  echo '[ "$(date -Ihours)" != "2021-03-15T22+08:00" ] && export TZ=UTC-08'
   427	  echo '[ "$DEBIAN_FRONTEND" = noninteractive ] && unset DEBIAN_FRONTEND && export DEBIAN_FRONTEND'
   428	  echo '[ "$DEBIAN_FRONTEND" = newt ]           && unset DEBIAN_FRONTEND && export DEBIAN_FRONTEND'
   429	  echo '# container environment (--env)'
   430	  echo "export 'container=docker'"
   431	  echo "export 'XAUTHORITY=/x11docker/Xauthority.client'"
   432	  echo "export 'DISPLAY=:1'"
   433	  echo "export 'HOME=/tmp'"
   434	  echo ''
   435	  echo 'env >> /x11docker/container.environment'
   436	  echo 'verbose "Container environment:'
   437	  echo '$(env | sort)"'
   438	  echo ''
   439	  echo 'cd "$HOME"'
   440	  [ "$Workdir" ] && echo "[ -d \"$Workdir\" ] && cd \"$Workdir\"    # WORKDIR in image"
   441	  echo ''
   442	  echo "$Exec \$Dbus $Entrypoint $Containercommand"
   443	} >> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/containerrc
   444	######## End of containerrc ########
   445	
   446	# Write containerrc into x11docker.log
   447	nl -ba >> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/x11docker.log < /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/containerrc
   448	
   449	######## Create cmdrc ########
   450	{ echo '#! /bin/sh'
   451	  echo '# Created startscript for cmdrc containing final container command'
   452	  echo ''
   453	  echo 'storeinfo () 
   454	{ 
   455	    [ -e "$Storeinfofile" ] || return 1;
   456	    case "${1:-}" in 
   457	        dump)
   458	            grep "^${2:-}=" $Storeinfofile | sed "s/^${2:-}=//"
   459	        ;;
   460	        drop)
   461	            sed -i "/^${2:-}=/d" $Storeinfofile
   462	        ;;
   463	        test)
   464	            grep -q "^${2:-}=" $Storeinfofile
   465	        ;;
   466	        *)
   467	            debugnote "storeinfo(): ${1:-}";
   468	            grep -q "^$(echo "${1:-}" | cut -d= -f1)=" $Storeinfofile && { 
   469	                sed -i "/^$(echo "${1:-}" | cut -d= -f1)=/d" $Storeinfofile
   470	            };
   471	            echo "${1:-}" >> $Storeinfofile
   472	        ;;
   473	    esac
   474	}'
   475	  echo '
   476	warning() {
   477	  echo "$*:WARNING"   | sed "s/\$/ /" >>$Messagefile
   478	}
   479	note() {
   480	  echo "$*:NOTE"      | sed "s/\$/ /" >>$Messagefile
   481	}
   482	verbose() {
   483	  echo "$*:VERBOSE"   | sed "s/\$/ /" >>$Messagefile
   484	}
   485	debugnote() {
   486	  echo "$*:DEBUGNOTE" | sed "s/\$/ /" >>$Messagefile
   487	}
   488	error() {
   489	  echo "$*:ERROR"     | sed "s/\$/ /" >>$Messagefile
   490	  exit 64
   491	}
   492	stdout() {
   493	  echo "$*:STDOUT"    | sed "s/\$/ /" >>$Messagefile
   494	}'
   495	  echo 'Messagefile=/x11docker/message.fifo'
   496	  echo "debugnote \"cmdrc: Running container command: 
   497	  $Entrypoint $Containercommand
   498	  \""
   499	  echo ''
   500	  echo "$Entrypoint $Containercommand  "
   501	  echo ''
   502	  echo '[ -h "$Homesoftlink" ] && rm $Homesoftlink'
   503	  echo "storeinfo cmdexitcode=\$?"
   504	} >> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/cmdrc
   505	######## End of cmdrc ########
   506	
   507	# Write cmdrc into x11docker.log
   508	nl -ba >> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/x11docker.log < /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/cmdrc
   509	
   510	# Send signal to run X and wait for X to be ready
   511	storeinfo readyforX=ready
   512	waitforlogentry 'dockerrc' /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/xinit.log 'xinitrc is ready' 'xinit: giving up|unable to connect to X server|Connection refused|server error|Only console users are allowed'
   513	
   514	rocknroll || exit 64
   515	
   516	
   517	rocknroll || exit 64
   518	
   519	
   520	#### run docker image ####
   521	docker run --tty --interactive \
   522	  --name x11docker_X1_sickcodes-docker-osx-latest_19253248706 \
   523	  --ipc host \
   524	  --security-opt label=type:container_runtime_t \
   525	  --volume '/usr/bin/docker-init':'/usr/local/bin/init':ro \
   526	  --tmpfs /run --tmpfs /run/lock \
   527	  --volume '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share':'/x11docker':rw \
   528	  --volume '/tmp/.X11-unix/X1':'/X1':rw \
   529	  --workdir '/home/arch/OSX-KVM' \
   530	  --entrypoint env \
   531	  --env 'container=docker' \
   532	  --env 'XAUTHORITY=/x11docker/Xauthority.client' \
   533	  --env 'DISPLAY=:1' \
   534	  --env 'HOME=/tmp' \
   535	   '-p' '50922:10022' \
   536	  -- sickcodes/docker-osx:latest /usr/local/bin/init -- /bin/sh - /x11docker/containerrc <&0 &
   537	Containerid=x11docker_X1_sickcodes-docker-osx-latest_19253248706
   538	##########################
   539	
   540	
   541	[ "$Containerid" ] || {
   542	    error "Startup of docker failed. Did not receive a container ID.
   543	    
   544	  Last lines of container log:
   545	$(rmcr < /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log | tail)"
   546	}
   547	storeinfo containerid="$Containerid"
   548	# Wait for container to be ready
   549	for ((Count=1 ; Count<=40 ; Count++)); do
   550	  docker exec x11docker_X1_sickcodes-docker-osx-latest_19253248706 sh -c : 2>&1 | rmcr >>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log && { debugnote 'dockerrc: Container is up and running.' ; break ; } || debugnote "dockerrc: Container not ready on $Count. attempt, trying again."
   551	  rocknroll || exit 64
   552	  mysleep 0.1
   553	done
   554	
   555	# Wait for pid 1 in container
   556	for ((Count=1 ; Count<=40 ; Count++)); do
   557	  Pid1pid="$(docker inspect --format '{{.State.Pid}}' x11docker_X1_sickcodes-docker-osx-latest_19253248706 2>>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log | rmcr)"
   558	  debugnote "dockerrc: $Count. check for PID 1: $Pid1pid"
   559	  checkpid "$Pid1pid" && break
   560	  rocknroll || exit 64
   561	  mysleep 0.1
   562	done
   563	[ "$Pid1pid" = "0" ] && Pid1pid=""
   564	[ -z "$Pid1pid" ] && error "dockerrc(): Did not receive PID of PID1 in container.
   565	  Maybe the container immediately stopped for unknown reasons.
   566	  Just in case, check if host and image architecture are compatible:
   567	  Host architecture: amd64 (x86_64), image architecture: $Containerarchitecture.
   568	  Output of \"docker ps | grep x11docker\":
   569	$(docker ps | grep x11docker)
   570	  
   571	  Content of container log:
   572	$(rmcr < /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log | uniq )"
   573	storeinfo pid1pid="$Pid1pid"
   574	
   575	# Get IP of container
   576	Containerip="$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' x11docker_X1_sickcodes-docker-osx-latest_19253248706 2>>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log)"
   577	storeinfo containerip=$Containerip
   578	
   579	# Check log for startup failure
   580	Failure="$(rmcr < /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log | grep -v grep | grep -E 'Error response from daemon|OCI runtime exec' ||:)"
   581	[ "$Failure" ] && {
   582	  echo "$Failure" >>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log
   583	  error "Got error message from docker daemon:
   584	$Failure
   585	
   586	  Last lines of logfile:
   587	$(tail /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log)"
   588	}
   589	
   590	debugnote 'dockerrc(): Starting containerrootrc with privileged docker exec'
   591	# copy containerrootrc inside of container to avoid possible noexec of host home.
   592	docker exec --privileged x11docker_X1_sickcodes-docker-osx-latest_19253248706 sh -c 'cp /x11docker/containerrootrc /tmp/containerrootrc ; chmod 644 /tmp/containerrootrc' 2>&1 | rmcr >>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log
   593	# run container root setup. containerrc will wait until setup script is ready.
   594	docker exec --privileged -u root x11docker_X1_sickcodes-docker-osx-latest_19253248706 /bin/sh /tmp/containerrootrc 2>&1 | rmcr >>/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log
   595	
   596	storeinfo dockerrc=ready
   597	
   598	[ "$Containerid" ] || [ "$Wmcontainerid" ] && {
   599	  # wait for signal of finish()
   600	  read Signal </home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/dockerrc.stopfifo
   601	  [ "$Signal" = "stop" ] && {
   602	    [ "$Containerid" ]   && docker stop $Containerid     >> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log 2>&1 &
   603	    [ "$Wmcontainerid" ] && docker stop $Wmcontainerid   >> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log 2>&1 &
   604	    [ "$Dockerlogspid" ] && kill $Dockerlogspid              >> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log 2>&1 &
   605	  }
   606	} & storepid $! dockerstopshell
   607	exit 0

x11docker[22:40:55,806]: Generated containerrootrc:
     1	#! /bin/sh
     2	
     3	# containerrootrc
     4	# This Script is executed as root in container.
     5	# - Create container user
     6	# - Time zone
     7	# - Install NVIDIA driver if requested
     8	# - Set up init system services and DBus for --init=systemd|openrc|runit|sysvinit
     9	
    10	# redirect output to have it available before 'docker logs' starts. --init=runit (void) would eat up the output at all for unknown reasons.
    11	exec 1>>/x11docker/container.log 2>&1
    12	
    13	storeinfo () 
    14	{ 
    15	    [ -e "$Storeinfofile" ] || return 1;
    16	    case "${1:-}" in 
    17	        dump)
    18	            grep "^${2:-}=" $Storeinfofile | sed "s/^${2:-}=//"
    19	        ;;
    20	        drop)
    21	            sed -i "/^${2:-}=/d" $Storeinfofile
    22	        ;;
    23	        test)
    24	            grep -q "^${2:-}=" $Storeinfofile
    25	        ;;
    26	        *)
    27	            debugnote "storeinfo(): ${1:-}";
    28	            grep -q "^$(echo "${1:-}" | cut -d= -f1)=" $Storeinfofile && { 
    29	                sed -i "/^$(echo "${1:-}" | cut -d= -f1)=/d" $Storeinfofile
    30	            };
    31	            echo "${1:-}" >> $Storeinfofile
    32	        ;;
    33	    esac
    34	}
    35	rocknroll () 
    36	{ 
    37	    [ -s "$Timetosaygoodbyefile" ] && return 1;
    38	    [ -e "$Timetosaygoodbyefile" ] || return 1;
    39	    return 0
    40	}
    41	
    42	warning() {
    43	  echo "$*:WARNING"   | sed "s/\$/ /" >>$Messagefile
    44	}
    45	note() {
    46	  echo "$*:NOTE"      | sed "s/\$/ /" >>$Messagefile
    47	}
    48	verbose() {
    49	  echo "$*:VERBOSE"   | sed "s/\$/ /" >>$Messagefile
    50	}
    51	debugnote() {
    52	  echo "$*:DEBUGNOTE" | sed "s/\$/ /" >>$Messagefile
    53	}
    54	error() {
    55	  echo "$*:ERROR"     | sed "s/\$/ /" >>$Messagefile
    56	  exit 64
    57	}
    58	stdout() {
    59	  echo "$*:STDOUT"    | sed "s/\$/ /" >>$Messagefile
    60	}
    61	Messagefile=/x11docker/message.fifo
    62	Storeinfofile='/x11docker/store.info'
    63	Timetosaygoodbyefile=/x11docker/timetosaygoodbye
    64	
    65	debugnote 'Running containerrootrc: Setup as root in container'
    66	
    67	Error=''
    68	for Line in cat chmod chown cut cd cp date echo env export grep id ln ls mkdir mv printf rm sed sh sleep tail touch; do
    69	  command -v "$Line" || {
    70	    warning "ERROR: Command not found in image: $Line"
    71	    Error=1
    72	  }
    73	done
    74	[ "$Error" ] && error 'Commands for container setup missing in image.
    75	  You can try with option --no-setup to avoid this error.'
    76	
    77	# Check type of libc
    78	ldd --version 2>&1 | grep -q 'musl libc' && Containerlibc='musl'
    79	ldd --version 2>&1 | grep -q -E 'GLIBC|GNU libc'  && Containerlibc='glibc'
    80	debugnote "containerrootrc: Container libc: $Containerlibc"
    81	
    82	# Prepare X environment
    83	# Create some system dirs with needed permissions
    84	mkdir -v -p /var/lib/dbus /var/run/dbus
    85	mkdir -v -p -m 1777 /tmp/.ICE-unix /tmp/.X11-unix /tmp/.font-unix
    86	chmod -c 1777 /tmp/.ICE-unix /tmp/.X11-unix /tmp/.font-unix
    87	export DISPLAY=:1 XAUTHORITY=/x11docker/Xauthority.client
    88	
    89	# workaround: autostart of xrandr for some desktops like deepin, cinnamon and gnome to fix wrong autoresize
    90	echo '#! /bin/sh
    91	Output=$(xrandr | grep ' connected' | cut -d" " -f1)
    92	Mode=1920x1080
    93	xrandr --output $Output --mode $Mode\n' > /usr/local/bin/x11docker-xrandr
    94	chmod +x /usr/local/bin/x11docker-xrandr
    95	mkdir -p /etc/xdg/autostart
    96	echo '[Desktop Entry]
    97	Encoding=UTF-8
    98	Version=0.9.4
    99	Type=Application
   100	Name=x11docker-xrandr
   101	Comment=
   102	Exec=/usr/local/bin/x11docker-xrandr
   103	' > /etc/xdg/autostart/x11docker-xrandr.desktop
   104	
   105	# Time zone
   106	[ ! -d /usr/share/zoneinfo ] && [ "$Containerlibc" = "glibc" ] && {
   107	  mkdir -p /usr/share/zoneinfo/Asia
   108	  cp '/x11docker/libc.localtime' '/usr/share/zoneinfo/Asia/Shanghai'
   109	}
   110	[ -e '/usr/share/zoneinfo/Asia/Shanghai' ] && ln -f -s '/usr/share/zoneinfo/Asia/Shanghai' /etc/localtime
   111	
   112	# Container system
   113	Containersystem="$(grep '^ID=' /etc/os-release 2>/dev/null | cut -d= -f2 || echo 'unknown')"
   114	verbose "Container system ID: $Containersystem"
   115	
   116	# Environment variables
   117	export 'container=docker'
   118	export 'XAUTHORITY=/x11docker/Xauthority.client'
   119	export 'DISPLAY=:1'
   120	export 'HOME=/tmp'
   121	
   122	# Check container user
   123	Containeruser="$(storeinfo dump containeruser)"
   124	
   125	Containeruserhome="$(cat /etc/passwd | grep '$Containeruser:.:' | cut -d: -f6)"
   126	Containeruserhome="${Containeruserhome:-/tmp/$Containeruser}"
   127	
   128	debugnote "containerrootrc: Container user: $(id $Containeruser)
   129	$(cat /etc/passwd | grep '$Containeruser:.:')"
   130	
   131	# Set up container user groups
   132	# Create HOME
   133	mkdir -p $Containeruserhome
   134	chown $Containeruser:$(id -g $Containeruser) "$Containeruserhome"
   135	ls -la $Containeruserhome
   136	
   137	rocknroll || exit 64
   138	
   139	
   140	# disable getty in inittab
   141	[ -e /etc/inittab ] && sed -i 's/.*getty/##getty disabled by x11docker## \0/' /etc/inittab
   142	
   143	
   144	rocknroll || exit 64
   145	
   146	storeinfo containerrootrc=ready
   147	

x11docker[22:40:55,823]: Generated xinitrc:
     1	#! /bin/sh
     2	disable_xhost () 
     3	{ 
     4	    local Line=;
     5	    command -v xhost > /dev/null || { 
     6	        warning "Command 'xhost' not found.
     7	  Can not check for possibly allowed network access to X.
     8	  Please install 'xhost'.";
     9	        return 1
    10	    };
    11	    xhost 2>&1 | tail -n +2 /dev/stdin | while read -r Line; do
    12	        debugnote "xhost: Removing entry $Line";
    13	        xhost -$Line;
    14	    done;
    15	    xhost -;
    16	    [ "$(xhost 2>&1 | wc -l)" -gt "1" ] && { 
    17	        warning "Remaining xhost permissions found on display ${DISPLAY:-}
    18	$(xhost 2>&1 )";
    19	        return 1
    20	    };
    21	    xhost 2>&1 | grep "access control disabled" && { 
    22	        warning "Failed to restrict xhost permissions.
    23	  Access to display ${DISPLAY:-} is allowed for everyone.";
    24	        return 1
    25	    };
    26	    return 0
    27	}
    28	pspid () 
    29	{ 
    30	    LC_ALL=C ps -p "${1:-}" 2> /dev/null | grep -v 'TIME'
    31	}
    32	rocknroll () 
    33	{ 
    34	    [ -s "$Timetosaygoodbyefile" ] && return 1;
    35	    [ -e "$Timetosaygoodbyefile" ] || return 1;
    36	    return 0
    37	}
    38	storeinfo () 
    39	{ 
    40	    [ -e "$Storeinfofile" ] || return 1;
    41	    case "${1:-}" in 
    42	        dump)
    43	            grep "^${2:-}=" $Storeinfofile | sed "s/^${2:-}=//"
    44	        ;;
    45	        drop)
    46	            sed -i "/^${2:-}=/d" $Storeinfofile
    47	        ;;
    48	        test)
    49	            grep -q "^${2:-}=" $Storeinfofile
    50	        ;;
    51	        *)
    52	            debugnote "storeinfo(): ${1:-}";
    53	            grep -q "^$(echo "${1:-}" | cut -d= -f1)=" $Storeinfofile && { 
    54	                sed -i "/^$(echo "${1:-}" | cut -d= -f1)=/d" $Storeinfofile
    55	            };
    56	            echo "${1:-}" >> $Storeinfofile
    57	        ;;
    58	    esac
    59	}
    60	storepid () 
    61	{ 
    62	    case "${1:-}" in 
    63	        dump)
    64	            grep -w "${2:-}" "$Storepidfile" | cut -d' ' -f1
    65	        ;;
    66	        test)
    67	            grep -q -w "${2:-}" "$Storepidfile"
    68	        ;;
    69	        *)
    70	            echo "${1:-NOPID}" "${2:-NONAME}" >> "$Storepidfile";
    71	            debugnote "storepid(): Stored pid '${1:-}' of '${2:-}': $(pspid ${1:-} ||:)"
    72	        ;;
    73	    esac
    74	}
    75	
    76	warning() {
    77	  echo "$*:WARNING"   | sed "s/\$/ /" >>$Messagefile
    78	}
    79	note() {
    80	  echo "$*:NOTE"      | sed "s/\$/ /" >>$Messagefile
    81	}
    82	verbose() {
    83	  echo "$*:VERBOSE"   | sed "s/\$/ /" >>$Messagefile
    84	}
    85	debugnote() {
    86	  echo "$*:DEBUGNOTE" | sed "s/\$/ /" >>$Messagefile
    87	}
    88	error() {
    89	  echo "$*:ERROR"     | sed "s/\$/ /" >>$Messagefile
    90	  exit 64
    91	}
    92	stdout() {
    93	  echo "$*:STDOUT"    | sed "s/\$/ /" >>$Messagefile
    94	}
    95	getscreensize() {
    96	  CurrentXaxis="$(xrandr | grep primary | cut -d' ' -f4 | cut -dx -f1 )"
    97	  CurrentYaxis="$(xrandr | grep primary | cut -d' ' -f4 | cut -dx -f2 | cut -d+ -f1)"
    98	}
    99	checkscreensize() {
   100	  getscreensize
   101	  [ "$Xaxis" = "$CurrentXaxis" ] || return 1
   102	  [ "$Yaxis" = "$CurrentYaxis" ] || return 1
   103	  return 0
   104	}
   105	getprimary() {
   106	  xrandr | grep -q primary || xrandr --output $(xrandr | grep ' connected' | head -n1 | cut -d' ' -f1) --primary
   107	  echo $(xrandr | grep primary | cut -d' ' -f1)
   108	}
   109	
   110	Messagefile='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/message.fifo'
   111	Output="$(getprimary)"
   112	Storeinfofile='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/store.info'
   113	Storepidfile='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/store.pids'
   114	Timetosaygoodbyefile='/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/timetosaygoodbye'
   115	
   116	export PATH='/home/werner/.pyenv/plugins/pyenv-virtualenv/shims:/home/werner/.pyenv/shims:/home/werner/.pyenv/plugins/pyenv-virtualenv/shims:/home/werner/.pyenv/shims:/home/werner/.local/bin:/home/werner/Public/repo/github.com/mviereck/x11docker.git:/opt/texlive/2020/bin/x86_64-linux:/home/werner/Public/repo/github.com/BurntSushi/ripgrep.git/target/release:/opt/apache-maven/3.6.3/bin:/opt/openjdk/jdk-14.0.1/bin:/usr/local/nginx/sbin:/home/werner/Public/repo/github.com/smxi/inxi.git:/home/werner/Public/repo/github.com/junegunn/fzf.git/bin:/home/werner/.pyenv/bin:/home/werner/Public/repo/github.com/golang/go.git/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/home/werner/go/bin:'
   117	
   118	Cookie=''
   119	Line=''
   120	Var=''
   121	
   122	debugnote 'Running xinitrc'
   123	
   124	export  DISPLAY=:1 XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client XSOCKET=/tmp/.X11-unix/X1 XDG_RUNTIME_DIR=/run/user/1000
   125	# background color
   126	
   127	# create new XAUTHORITY cookies
   128	:> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
   129	
   130	export XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/Xauthority.host.1
   131	xhost | grep -q 'SI:localuser:werner' || { xhost +SI:localuser:werner ; Xhostentry='yes' ; }
   132	
   133	echo 'Requesting trusted cookie from X server'
   134	xauth -v -i -f /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client generate :1 . trusted timeout 3600
   135	
   136	[ -s '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client' ] || { 
   137	  [ 'trusted' = 'untrusted' ] && note 'Could not create untrusted cookie. 
   138	  Maybe your X server misses extension SECURITY.'
   139	  [ 'trusted' = 'untrusted' ] && warning 'SECURITY RISK! Keylogging and remote host control 
   140	  may be possible! Better avoid using option --hostdisplay,
   141	  rather use --nxagent or --xpra.'
   142	  cp /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/Xauthority.host.1 /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
   143	}
   144	[ -s '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client' ] || { 
   145	  # still no cookie? try to create one without extension security
   146	  debugnote 'xinitrc: Failed to retrieve trusted cookie from X server. Will bake one myself.'
   147	  echo 'Failed to retrieve trusted cookie from X server. Will bake one myself.'
   148	  xauth -v -i -f /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client add :1 . 9870511e64511aeb675aed7c26464f4c
   149	  ls -l /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
   150	}
   151	
   152	# Prepare cookie with localhost identification disabled by ffff, needed if X socket is shared. ffff means 'familiy wild'
   153	Cookie="$(xauth -i -f /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client nlist | sed -e 's/^..../ffff/')"
   154	echo "$Cookie" | xauth -v -i -f /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client nmerge -
   155	
   156	debugnote "xinitrc: Created cookie: $(xauth -f /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client list 2>&1)"
   157	ls -l /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
   158	cp /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/Xauthority.server
   159	chmod 644 /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
   160	
   161	[ -s '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client' ] || warning 'Cookie creation failed!'
   162	[ '$Xhostentry' = 'yes' ] && env XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/Xauthority.host.1 xhost -SI:localuser:werner
   163	export XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
   164	[ 'yes' = 'no' ] || [ ! -s '/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client' ] && unset XAUTHORITY && warning '--hostdisplay: X server :1 runs without cookie authentication.'
   165	
   166	verbose "Output of xrandr on :1
   167	$(xrandr)"
   168	
   169	echo 'xinitrc: xinitrc is ready'
   170	storeinfo xinitrc=ready
   171	
   172	# wait for the end
   173	read Var </home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/timetosaygoodbye.fifo

DEBUGNOTE[22:40:55,858]: Running xtermrc: Ask for password if needed (no)
DEBUGNOTE[22:40:55,876]: storepid(): Stored pid '784511' of 'containershell':  784511 pts/1    00:00:00 bash
DEBUGNOTE[22:40:55,878]: Running dockerrc: Setup as root or as user docker on host.
DEBUGNOTE[22:40:55,889]: waitforlogentry(): start_xserver(): Waiting for logentry "readyforX=ready" in store.info

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
WARNING: No swap limit support
WARNING: No blkio weight support
WARNING: No blkio weight_device support

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:56,058]: dockerrc: Found default Runtime: runc
DEBUGNOTE[22:40:56,077]: dockerrc: All  Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux nvidia runc
DEBUGNOTE[22:40:56,097]: dockerrc: Container Runtime: runc
DEBUGNOTE[22:40:56,116]: storeinfo(): runtime=runc
DEBUGNOTE[22:40:56,301]: dockerrc: Image architecture: 
DEBUGNOTE[22:40:56,322]: dockerrc: Image CMD: /bin/bash -c sudo touch /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; sudo chown -R $(id -u):$(id -g) /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; 
     1	#! /bin/sh
     2	
     3	# containerrc
     4	# Created startscript for docker run used as container command.
     5	# Runs as unprivileged user in container.
     6	
     7	
     8	mysleep () 
     9	{ 
    10	    sleep "${1:-1}" 2> /dev/null || sleep 1
    11	}
    12	rocknroll () 
    13	{ 
    14	    [ -s "$Timetosaygoodbyefile" ] && return 1;
    15	    [ -e "$Timetosaygoodbyefile" ] || return 1;
    16	    return 0
    17	}
    18	saygoodbye () 
    19	{ 
    20	    debugnote "time to say goodbye ($*)";
    21	    [ -e "$Timetosaygoodbyefile" ] && echo timetosaygoodbye >> $Timetosaygoodbyefile;
    22	    [ -e "$Timetosaygoodbyefifo" ] && echo timetosaygoodbye >> $Timetosaygoodbyefifo
    23	}
    24	storeinfo () 
    25	{ 
    26	    [ -e "$Storeinfofile" ] || return 1;
    27	    case "${1:-}" in 
    28	        dump)
    29	            grep "^${2:-}=" $Storeinfofile | sed "s/^${2:-}=//"
    30	        ;;
    31	        drop)
    32	            sed -i "/^${2:-}=/d" $Storeinfofile
    33	        ;;
    34	        test)
    35	            grep -q "^${2:-}=" $Storeinfofile
    36	        ;;
    37	        *)
    38	            debugnote "storeinfo(): ${1:-}";
    39	            grep -q "^$(echo "${1:-}" | cut -d= -f1)=" $Storeinfofile && { 
    40	                sed -i "/^$(echo "${1:-}" | cut -d= -f1)=/d" $Storeinfofile
    41	            };
    42	            echo "${1:-}" >> $Storeinfofile
    43	        ;;
    44	    esac
    45	}
    46	waitforlogentry () 
    47	{ 
    48	    local Startzeit Uhrzeit Dauer Count=0 Schlaf;
    49	    local Errorkeys="${4:-}";
    50	    local Warten="${5:-60}";
    51	    local Error=;
    52	    Startzeit="$(date +%s ||:)";
    53	    Startzeit="${Startzeit:-0}";
    54	    [ "$Warten" = "infinity" ] && Warten=32000;
    55	    debugnote "waitforlogentry(): ${1:-}: Waiting for logentry \"${3:-}\" in $(basename ${2:-})";
    56	    while ! grep -q "${3:-}" < "${2:-}"; do
    57	        Count="$(( $Count + 1 ))";
    58	        Uhrzeit="$(date +%s ||:)";
    59	        Uhrzeit="${Uhrzeit:-0}";
    60	        Dauer="$(( $Uhrzeit - $Startzeit ))";
    61	        Schlaf="$(( $Count / 10 ))";
    62	        [ "$Schlaf" = "0" ] && Schlaf="0.5";
    63	        mysleep "$Schlaf";
    64	        [ "$Dauer" -gt "10" ] && debugnote "waitforlogentry(): ${1:-}: Waiting since ${Dauer}s for log entry \"${3:-}\" in $(basename ${2:-})";
    65	        [ "$Dauer" -gt "$Warten" ] && error "waitforlogentry(): ${1:-}: Timeout waiting for entry \"${3:-}\" in $(basename ${2:-})
    66	  Last lines of $(basename ${2:-}):
    67	$(tail "${2:-}")";
    68	        [ "$Errorkeys" ] && grep -i -q -E "$Errorkeys" < "${2:-}" && error "waitforlogentry(): ${1:-}: Found error message in logfile.
    69	  Last lines of logfile $(basename ${2:-}):
    70	$(tail "${2:-}")";
    71	        rocknroll || { 
    72	            debugnote "waitforlogentry(): ${1:-}: Stopped waiting for ${3:-} in $(basename ${2:-}) due to terminating signal.";
    73	            Error=1;
    74	            break
    75	        };
    76	    done;
    77	    [ "$Error" ] && return 1;
    78	    debugnote "waitforlogentry(): ${1:-}: Found log entry \"${3:-}\" in $(basename ${2:-}).";
    79	    return 0
    80	}
    81	
    82	warning() {
    83	  echo "$*:WARNING"   | sed "s/\$/ /" >>$Messagefile
    84	}
    85	note() {
    86	  echo "$*:NOTE"      | sed "s/\$/ /" >>$Messagefile
    87	}
    88	verbose() {
    89	  echo "$*:VERBOSE"   | sed "s/\$/ /" >>$Messagefile
    90	}
    91	debugnote() {
    92	  echo "$*:DEBUGNOTE" | sed "s/\$/ /" >>$Messagefile
    93	}
    94	error() {
    95	  echo "$*:ERROR"     | sed "s/\$/ /" >>$Messagefile
    96	  exit 64
    97	}
    98	stdout() {
    99	  echo "$*:STDOUT"    | sed "s/\$/ /" >>$Messagefile
   100	}
   101	Messagefile=/x11docker/message.fifo
   102	Storeinfofile=/x11docker/store.info
   103	Timetosaygoodbyefile=/x11docker/timetosaygoodbye
   104	
   105	waitforlogentry containerrc $Storeinfofile containerrootrc=ready  infinity
   106	debugnote "Running containerrc: Unprivileged user commands in container"
   107	
   108	Containercommand="/bin/bash -c sudo touch /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; sudo chown -R $(id -u):$(id -g) /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; "
   109	Entrypoint=""
   110	
   111	verbose "containerrc: Container system:
   112	$(cat /etc/os-release 2>&1 ||:)"
   113	
   114	
   115	# USER and HOME
   116	Containeruser="$(storeinfo dump containeruser)"
   117	Containeruserhome="$(cat /etc/passwd | grep "$Containeruser:.:" | cut -d: -f6)"
   118	Containeruserhome="${Containeruserhome:-/tmp/$Containeruser}"
   119	mkdir -p "$Containeruserhome"
   120	export USER="$Containeruser"
   121	export HOME="$Containeruserhome"
   122	
   123	# XDG_RUNTIME_DIR
   124	Containeruseruid=$(id -u $Containeruser)
   125	export XDG_RUNTIME_DIR=/tmp/XDG_RUNTIME_DIR
   126	[ -e /run/user/$Containeruseruid ] && ln -s /run/user/$Containeruseruid $XDG_RUNTIME_DIR || mkdir -p -m700 $XDG_RUNTIME_DIR
   127	
   128	# Copy files from /etc/skel into empty HOME
   129	[ -d /etc/skel ] && [ -z "$(ls -A "$Containeruserhome" 2>/dev/null | grep -v -E "gnupg")" ] && {
   130	  debugnote "containerrc: HOME is empty. Copying from /etc/skel"
   131	  cp -n -R /etc/skel/. $Containeruserhome
   132	  :
   133	} || {
   134	  debugnote "containerrc: HOME is not empty. Not copying from /etc/skel"
   135	}
   136	
   137	# Create softlink to X unix socket
   138	[ -e /tmp/.X11-unix/X1 ] || ln -s /X1 /tmp/.X11-unix
   139	
   140	unset WAYLAND_DISPLAY
   141	
   142	export XDG_SESSION_TYPE=x11
   143	
   144	
   145	export TERM=xterm
   146	storeinfo test locale && export LANG="$(storeinfo dump locale)"
   147	[ -e "/usr/share/zoneinfo/Asia/Shanghai" ] || export TZ=UTC-08
   148	[ "$(date -Ihours)" != "2021-03-15T22+08:00" ] && export TZ=UTC-08
   149	[ "$DEBIAN_FRONTEND" = noninteractive ] && unset DEBIAN_FRONTEND && export DEBIAN_FRONTEND
   150	[ "$DEBIAN_FRONTEND" = newt ]           && unset DEBIAN_FRONTEND && export DEBIAN_FRONTEND
   151	# container environment (--env)
   152	export 'container=docker'
   153	export 'XAUTHORITY=/x11docker/Xauthority.client'
   154	export 'DISPLAY=:1'
   155	export 'HOME=/tmp'
   156	
   157	env >> /x11docker/container.environment
   158	verbose "Container environment:
   159	$(env | sort)"
   160	
   161	cd "$HOME"
   162	[ -d "/home/arch/OSX-KVM" ] && cd "/home/arch/OSX-KVM"    # WORKDIR in image
   163	
   164	 $Dbus  /bin/bash -c sudo touch /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; sudo chown -R $(id -u):$(id -g) /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; 
     1	#! /bin/sh
     2	# Created startscript for cmdrc containing final container command
     3	
     4	storeinfo () 
     5	{ 
     6	    [ -e "$Storeinfofile" ] || return 1;
     7	    case "${1:-}" in 
     8	        dump)
     9	            grep "^${2:-}=" $Storeinfofile | sed "s/^${2:-}=//"
    10	        ;;
    11	        drop)
    12	            sed -i "/^${2:-}=/d" $Storeinfofile
    13	        ;;
    14	        test)
    15	            grep -q "^${2:-}=" $Storeinfofile
    16	        ;;
    17	        *)
    18	            debugnote "storeinfo(): ${1:-}";
    19	            grep -q "^$(echo "${1:-}" | cut -d= -f1)=" $Storeinfofile && { 
    20	                sed -i "/^$(echo "${1:-}" | cut -d= -f1)=/d" $Storeinfofile
    21	            };
    22	            echo "${1:-}" >> $Storeinfofile
    23	        ;;
    24	    esac
    25	}
    26	
    27	warning() {
    28	  echo "$*:WARNING"   | sed "s/\$/ /" >>$Messagefile
    29	}
    30	note() {
    31	  echo "$*:NOTE"      | sed "s/\$/ /" >>$Messagefile
    32	}
    33	verbose() {
    34	  echo "$*:VERBOSE"   | sed "s/\$/ /" >>$Messagefile
    35	}
    36	debugnote() {
    37	  echo "$*:DEBUGNOTE" | sed "s/\$/ /" >>$Messagefile
    38	}
    39	error() {
    40	  echo "$*:ERROR"     | sed "s/\$/ /" >>$Messagefile
    41	  exit 64
    42	}
    43	stdout() {
    44	  echo "$*:STDOUT"    | sed "s/\$/ /" >>$Messagefile
    45	}
    46	Messagefile=/x11docker/message.fifo
    47	debugnote "cmdrc: Running container command: 
    48	   /bin/bash -c sudo touch /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; sudo chown -R $(id -u):$(id -g) /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; 
    49	  "
    50	
    51	 /bin/bash -c sudo touch /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ; sudo chown -R $(id -u):$(id -g) /dev/kvm /dev/snd "${IMAGE_PATH}" "${BOOTDISK}" "${ENV}" || true     ;   
    52	
    53	[ -h "$Homesoftlink" ] && rm $Homesoftlink
    54	storeinfo cmdexitcode=$?
DEBUGNOTE[22:40:56,342]: dockerrc: Image USER: 
DEBUGNOTE[22:40:56,361]: storeinfo(): containeruser=root
DEBUGNOTE[22:40:56,381]: dockerrc: Image ENTRYPOINT: 
DEBUGNOTE[22:40:56,401]: storeinfo(): readyforX=ready
DEBUGNOTE[22:40:56,411]: waitforlogentry(): start_xserver(): Found log entry "readyforX=ready" in store.info.
DEBUGNOTE[22:40:56,421]: waitforlogentry(): dockerrc: Waiting for logentry "xinitrc is ready" in xinit.log

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/xinit.log <==
Requesting trusted cookie from X server
Ignoring locks on authority file /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
authorization id is 517
Ignoring locks and writing authority file /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
Ignoring locks on authority file /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
1 entries read in:  1 new, 0 replacements
Ignoring locks and writing authority file /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:56,517]: Running xinitrc

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/xinit.log <==
-rw------- 1 werner werner 102 Mar 15 22:40 /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:56,545]: xinitrc: Created cookie: X10DAi/unix:1  MIT-MAGIC-COOKIE-1  44db538a814aaa1776f0f7bdb09249ba 
#ffff#583130444169#:1  MIT-MAGIC-COOKIE-1  44db538a814aaa1776f0f7bdb09249ba

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/xinit.log <==
xinitrc: xinitrc is ready

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
x11docker[22:40:56,663]: Output of xrandr on :1 
Screen 0: minimum 8 x 8, current 1920 x 1080, maximum 32767 x 32767 
DP-0 disconnected (normal left inverted right x axis y axis) 
DP-1 disconnected (normal left inverted right x axis y axis) 
HDMI-0 connected primary 1920x1080+0+0 (normal left inverted right x axis y axis) 598mm x 336mm 
   1920x1080     60.00*+  74.97    59.94    50.00   
   1600x900      60.00   
   1280x1024     75.02    60.02   
   1280x720      60.00    59.94    50.00   
   1152x864      75.00   
   1024x768      75.03    60.00   
   800x600       75.00    60.32   
   720x576       50.00   
   720x480       59.94   
   640x480       75.00    59.94    59.93   
DP-2 disconnected (normal left inverted right x axis y axis) 
DP-3 disconnected (normal left inverted right x axis y axis) 
DP-4 disconnected (normal left inverted right x axis y axis) 
DP-5 disconnected (normal left inverted right x axis y axis) 
USB-C-0 disconnected (normal left inverted right x axis y axis)

DEBUGNOTE[22:40:56,681]: storeinfo(): xinitrc=ready
DEBUGNOTE[22:40:56,888]: waitforlogentry(): dockerrc: Found log entry "xinitrc is ready" in xinit.log.
DEBUGNOTE[22:40:56,908]: storeinfo(): containerid=x11docker_X1_sickcodes-docker-osx-latest_19253248706

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
Error: No such container: x11docker_X1_sickcodes-docker-osx-latest_19253248706

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:56,959]: dockerrc: Container is up and running.

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
Error: No such object: x11docker_X1_sickcodes-docker-osx-latest_19253248706

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:57,066]: dockerrc: 1. check for PID 1: 

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
Error: No such object: x11docker_X1_sickcodes-docker-osx-latest_19253248706

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:57,265]: dockerrc: 2. check for PID 1: 

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
Error: No such object: x11docker_X1_sickcodes-docker-osx-latest_19253248706

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:57,458]: dockerrc: 3. check for PID 1: 

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
Error: No such object: x11docker_X1_sickcodes-docker-osx-latest_19253248706

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:57,653]: dockerrc: 4. check for PID 1: 
DEBUGNOTE[22:40:57,882]: dockerrc: 5. check for PID 1: 0
DEBUGNOTE[22:40:58,582]: waitforlogentry(): containerrc: Waiting for logentry "containerrootrc=ready" in store.info
DEBUGNOTE[22:40:58,652]: dockerrc: 6. check for PID 1: 786967
DEBUGNOTE[22:40:58,671]: storeinfo(): pid1pid=786967
DEBUGNOTE[22:40:58,726]: storeinfo(): containerip=172.17.0.2
DEBUGNOTE[22:40:58,744]: dockerrc(): Starting containerrootrc with privileged docker exec

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
/usr/sbin/cat
/usr/sbin/chmod
/usr/sbin/chown
/usr/sbin/cut
cd
/usr/sbin/cp
/usr/sbin/date
echo
/usr/sbin/env
export
/usr/sbin/grep
/usr/sbin/id
/usr/sbin/ln
/usr/sbin/ls
/usr/sbin/mkdir
/usr/sbin/mv
printf
/usr/sbin/rm
/usr/sbin/sed
/usr/sbin/sh
/usr/sbin/sleep
/usr/sbin/tail
/usr/sbin/touch

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:59,156]: Running containerrootrc: Setup as root in container

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
mkdir: created directory '/var/run/dbus'
mkdir: created directory '/tmp/.ICE-unix'
mkdir: created directory '/tmp/.font-unix'
mode of '/tmp/.X11-unix' changed from 0755 (rwxr-xr-x) to 1777 (rwxrwxrwt)

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:59,178]: containerrootrc: Container libc: glibc
x11docker[22:40:59,207]: Container system ID: arch


==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/container.log <==
total 8
drwxr-xr-x 2 root root 4096 Mar 15 22:40 .
drwxrwxrwt 1 root root 4096 Mar 15 22:40 ..

==> /home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/message.log <==
DEBUGNOTE[22:40:59,235]: containerrootrc: Container user: uid=0(root) gid=0(root) groups=0(root) 
DEBUGNOTE[22:40:59,254]: storeinfo(): containerrootrc=ready
DEBUGNOTE[22:40:59,274]: storeinfo(): dockerrc=ready
DEBUGNOTE[22:40:59,330]: storepid(): Stored pid '787958' of 'dockerstopshell':  787958 pts/1    00:00:00 bash
DEBUGNOTE[22:40:59,336]: waitforlogentry(): start_docker(): Waiting for logentry "dockerrc=ready" in store.info
DEBUGNOTE[22:40:59,349]: waitforlogentry(): start_docker(): Found log entry "dockerrc=ready" in store.info.
DEBUGNOTE[22:40:59,351]: storeinfo(): xtermrc=ready
DEBUGNOTE[22:40:59,361]: watchpidlist(): Setting pid 786967 on watchlist: pid1pid
DEBUGNOTE[22:40:59,413]: storepid(): Stored pid '786967' of 'pid1pid':  786967 pts/0    00:00:00 init
DEBUGNOTE[22:40:59,413]: watchpidlist(): Watching pids: 
 786967 pts/0    00:00:00 init
DEBUGNOTE[22:40:59,568]: Process tree of container: (maybe not complete yet)
init(786967)---sh(787225)---sleep(787729)
DEBUGNOTE[22:40:59,647]: waitforlogentry(): containerrc: Found log entry "containerrootrc=ready" in store.info.
DEBUGNOTE[22:40:59,665]: Running containerrc: Unprivileged user commands in container
x11docker[22:40:59,720]: containerrc: Container system: 
NAME="Arch Linux" 
PRETTY_NAME="Arch Linux" 
ID=arch 
BUILD_ID=rolling 
ANSI_COLOR="38;2;23;147;209" 
HOME_URL="https://www.archlinux.org/" 
DOCUMENTATION_URL="https://wiki.archlinux.org/" 
SUPPORT_URL="https://bbs.archlinux.org/" 
BUG_REPORT_URL="https://bugs.archlinux.org/" 
LOGO=archlinux

DEBUGNOTE[22:40:59,738]: containerrc: HOME is empty. Copying from /etc/skel
x11docker[22:40:59,853]: Container environment: 
ADDITIONAL_PORTS= 
BOOTDISK= 
container=docker 
DISPLAY=:1 
ENV=/env 
GENERATE_SPECIFIC=false 
GENERATE_UNIQUE=false 
HEIGHT=1080 
HOME=/tmp 
HOSTNAME=a88734ef0637 
http_proxy=http://172.17.0.1:8080 
HTTP_PROXY=http://172.17.0.1:8080 
IMAGE_PATH=/home/arch/OSX-KVM/mac_hdd_ng.img 
LANG=en_US.UTF-8 
MASTER_PLIST_URL=https://raw.githubusercontent.com/sickcodes/osx-serial-generator/master/config-nopicker-custom.plist 
NETWORKING=vmxnet3 
NOPICKER=false 
no_proxy=localhost,127.0.0.1,.cn 
NO_PROXY=localhost,127.0.0.1,.cn 
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin 
PWD=/home/arch/OSX-KVM 
SHLVL=0 
TERM=xterm 
USER=root 
_=/usr/sbin/env 
WIDTH=1920 
XAUTHORITY=/x11docker/Xauthority.client 
XDG_RUNTIME_DIR=/tmp/XDG_RUNTIME_DIR 
XDG_SESSION_TYPE=x11

DEBUGNOTE[22:40:59,864]: Process tree of x11docker:
bash(781593)-+-bash(782954)---tail(782956)
             |-bash(782972)
             |-bash(783015)
             |-bash(784511)---bash(788248)---pstree(788249)
             `-bash(785253)
  Lost child of dockerrc (dockerstopshell):
    bash(787958)
DEBUGNOTE[22:40:59,872]: storeinfo(): Stored info:
cache=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706
stdout=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stdout
stderr=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/stderr
x11dockerpid=781593
xserver=--hostdisplay
DISPLAY=:1
XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client
XSOCKET=/tmp/.X11-unix/X1
XDG_RUNTIME_DIR=/run/user/1000
Xenv= DISPLAY=:1 XAUTHORITY=/home/werner/.cache/x11docker/sickcodes-docker-osx-latest-19253248706/share/Xauthority.client XSOCKET=/tmp/.X11-unix/X1 XDG_RUNTIME_DIR=/run/user/1000
tini=/usr/bin/docker-init
containername=x11docker_X1_sickcodes-docker-osx-latest_19253248706
runtime=runc
containeruser=root
readyforX=ready
xinitrc=ready
containerid=x11docker_X1_sickcodes-docker-osx-latest_19253248706
pid1pid=786967
containerip=172.17.0.2
containerrootrc=ready
dockerrc=ready
xtermrc=ready
DEBUGNOTE[22:40:59,881]: storepid(): Stored pids:
782972 watchpidlist
783015 watchmessagefifo
784511 containershell
787958 dockerstopshell
786967 pid1pid
DEBUGNOTE[22:40:59,886]: storeinfo(): x11docker=ready
DEBUGNOTE[22:41:00,420]: watchpidlist(): PID 786967 has terminated
DEBUGNOTE[22:41:00,425]: time to say goodbye (watchpidlist 786967)
DEBUGNOTE[22:41:00,432]: time to say goodbye (watchpidlist)
DEBUGNOTE[22:41:00,433]: time to say goodbye (main)
DEBUGNOTE[22:41:00,440]: Terminating x11docker.
DEBUGNOTE[22:41:00,446]: time to say goodbye (finish)
DEBUGNOTE[22:41:00,515]: finish(): Checking pid 786967 (pid1pid): (already gone)
DEBUGNOTE[22:41:00,574]: finish(): Checking pid 787958 (dockerstopshell):  787958 pts/1    00:00:00 bash
DEBUGNOTE[22:41:00,635]: finish(): Checking pid 784511 (containershell): (already gone)
DEBUGNOTE[22:41:00,697]: finish(): Checking pid 783015 (watchmessagefifo):  783015 pts/1    00:00:00 bash
DEBUGNOTE[22:41:00,756]: finish(): Checking pid 782972 (watchpidlist): (already gone)
DEBUGNOTE[22:41:00,952]: Removing container x11docker_X1_sickcodes-docker-osx-latest_19253248706
    x11docker_X1_sickcodes-docker-osx-latest_19253248706
DEBUGNOTE[22:41:02,074]: termpid(): Terminating 783015 (watchmessagefifo):  783015 pts/1    00:00:00 bash
DEBUGNOTE[22:41:02,204]: x11docker exit code: 0
